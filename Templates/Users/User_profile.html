<!DOCTYPE html>
<html lang="en">
{% load static %}
    <head>
        <meta charset="utf-8">
        <title>FArmToHome</title>
        <meta content="width=device-width, initial-scale=1.0" name="viewport">
        <meta content="" name="keywords">
        <meta content="" name="description">

        <!-- Google Web Fonts -->
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600&family=Raleway:wght@600;800&display=swap" rel="stylesheet"> 

        <!-- Icon Font Stylesheet -->
        <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.4/css/all.css"/>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.4.1/font/bootstrap-icons.css" rel="stylesheet">

        <!-- Libraries Stylesheet -->
        <link href="{% static 'lib/lightbox/css/lightbox.min.css' %}" rel="stylesheet">
        <link href="{% static 'lib/owlcarousel/assets/owl.carousel.min.css' %}" rel="stylesheet">


        <!-- Customized Bootstrap Stylesheet -->
        <link href="{% static 'Products/css/bootstrap.min.css' %}" rel="stylesheet">

        <!-- Template Stylesheet -->
        <link href="{% static 'Products/css/style.css' %}" rel="stylesheet">
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    </head>

    <body>

        <!-- Spinner Start -->
        <!-- <div id="spinner" class="show w-100 vh-100 bg-white position-fixed translate-middle top-50 start-50  d-flex align-items-center justify-content-center">
            <div class="spinner-grow text-primary" role="status"></div>
        </div> -->
        <!-- Spinner End -->


        <!-- Navbar start -->
        <div class="container-fluid fixed-top">
            <!-- <div class="container topbar bg-primary d-none d-lg-block">
                <div class="d-flex justify-content-between">
                    <div class="top-info ps-2">
                        <small class="me-3"><i class="fas fa-map-marker-alt me-2 text-secondary"></i> <a href="#" class="text-white"></a></small>
                        <small class="me-3"><i class="fas fa-envelope me-2 text-secondary"></i><a href="#" class="text-white">Farmtohome584@gmail.com</a></small>
                    </div>
                    <div class="top-link pe-2">
                        <a href="#" class="text-white"><small class="text-white mx-2">Privacy Policy</small>/</a>
                        <a href="#" class="text-white"><small class="text-white mx-2">Terms of Use</small>/</a>
                        <a href="#" class="text-white"><small class="text-white ms-2">Sales and Refunds</small></a>
                    </div>
                </div>
            </div> -->
            <div class="container px-0">
                <nav class="navbar navbar-light bg-white navbar-expand-xl">
                    <a href="{% url 'home' %}" class="navbar-brand"><h1 class="text-primary display-6">FarmtoHome</h1></a>
                    <button class="navbar-toggler py-2 px-3" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse">
                        <span class="fa fa-bars text-primary"></span>
                    </button>
                    <div class="collapse navbar-collapse bg-white" id="navbarCollapse">
                        <div class="navbar-nav mx-auto">
                            <a href="{% url 'home' %}" class="nav-item nav-link active">Home</a>
                            <a href="shop.html" class="nav-item nav-link">Shop</a>
                            <a href="shop-detail.html" class="nav-item nav-link">Shop Detail</a>
                            <div class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown">Pages</a>
                                <div class="dropdown-menu m-0 bg-secondary rounded-0">
                                    <a href="cart.html" class="dropdown-item">Cart</a>
                                    <a href="chackout.html" class="dropdown-item">Checkout</a>
                                    <a href="testimonial.html" class="dropdown-item">Testimonial</a>
                                    <a href="404.html" class="dropdown-item">404 Page</a>
                                </div>
                            </div>
                            <a href="contact.html" class="nav-item nav-link">Contact</a>
                        </div>
                        <div class="d-flex m-3 me-0">
                            <button class="btn-search btn border border-secondary btn-md-square rounded-circle bg-white me-4" data-bs-toggle="modal" data-bs-target="#searchModal"><i class="fas fa-search text-primary"></i></button>
                            <a href="#" class="position-relative me-4 my-auto">
                                <i class="fa fa-shopping-bag fa-2x"></i>
                                <span class="position-absolute bg-secondary rounded-circle d-flex align-items-center justify-content-center text-dark px-1" style="top: -5px; left: 15px; height: 20px; min-width: 20px;">3</span>
                            </a>
                            <div class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown">Hi,{{ user.username }}</a>
                                <div class="dropdown-menu m-0 bg-secondary rounded-0">
                                    <a href="cart.html" class="dropdown-item">Cart</a>
                                    <a href="checkout.html" class="dropdown-item">User Profile</a>
                                    <form action="{% url 'logout' %}" method="POST">
                                        {% csrf_token %}
                                        <button type="submit" class="dropdown-item">Logout
                                        </button>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </nav>
            </div>
        </div>
        <!-- Navbar End -->


        <!-- Modal Search Start -->
        <div class="modal fade" id="searchModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-fullscreen">
                <div class="modal-content rounded-0">
                    <div class="modal-header">
                        <h5 class="modal-title" id="exampleModalLabel">Search by keyword</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body d-flex align-items-center">
                        <div class="input-group w-75 mx-auto d-flex">
                            <input type="search" class="form-control p-3" placeholder="keywords" aria-describedby="search-icon-1">
                            <span id="search-icon-1" class="input-group-text p-3"><i class="fa fa-search"></i></span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- Modal Search End -->


        <!-- Hero Start -->
        <div class="modal fade" id="searchModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-fullscreen">
                <div class="modal-content rounded-0">
                    <div class="modal-header">
                        <h5 class="modal-title" id="exampleModalLabel">Search by keyword</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body d-flex align-items-center">
                        <div class="input-group w-75 mx-auto d-flex">
                            <input type="search" class="form-control p-3" placeholder="keywords" aria-describedby="search-icon-1">
                            <span id="search-icon-1" class="input-group-text p-3"><i class="fa fa-search"></i></span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- profile_updation.html -->
        <div class="container mt-5">
            <h2 class="mb-4 custom-text-color">Update Profile and Address</h2>
            {% if message.tags != 'success' %}
                <div class="alert-container">
                    {% for message in messages %}
                        <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                            {{ message }}
                            <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                    {% endfor %}
                </div>
            {% endif %}

            {% if user %}
            <form id="profileForm" method="POST" action="{% url 'profile_edit' %}">
                {% csrf_token %}
                <div class="card mb-4">
                    <div class="card-header custom-text-color">
                        <h3>Profile Details</h3>
                    </div>
                    <div class="card-body">
                        <div class="form-group">
                            <label for="id_first_name" class="custom-text-color">First Name</label>
                            <input type="text" class="form-control custom-text-color" id="id_first_name" name="first_name" value="{{ user.first_name }}">
                        </div>
                        <div class="form-group">
                            <label for="id_last_name" class="custom-text-color">Last Name</label>
                            <input type="text" class="form-control custom-text-color" id="id_last_name" name="last_name" value="{{ user.last_name }}">
                        </div>
                        <div class="form-group">
                            <label for="id_email" class="custom-text-color">Email</label>
                            <input type="email" class="form-control custom-text-color" id="id_email" name="email" value="{{ user.email }}">
                        </div>
                        <div class="form-group">
                            <label for="id_phone_number" class="custom-text-color">Phone Number</label>
                            <input type="text" class="form-control custom-text-color" id="id_phone_number" name="phone_number" value="{{ user.phone_number }}">
                        </div>
                    </div>
                </div>
                <div class="card mb-4">
                    <div class="card-header custom-text-color">
                        <h3>Address Details</h3>
                    </div>
                    <div class="card-body">
                        <div class="form-group">
                            <label for="id_street" class="custom-text-color">Street</label>
                            <input type="text" class="form-control custom-text-color" id="id_street" name="street" value="{{ address.address }}">
                        </div>
                        <div class="form-group">
                            <label for="id_city" class="custom-text-color">City</label>
                            <input type="text" class="form-control custom-text-color" id="id_city" name="city" value="{{ address.city }}">
                        </div>
                        <div class="form-group">
                            <label for="id_zip_code" class="custom-text-color">Zip Code</label>
                            <input type="text" class="form-control custom-text-color" id="id_zip_code" name="zip_code" value="{{ address.zip_code }}">
                        </div>
                        <div class="form-group">
                            <label for="id_country" class="custom-text-color">Country</label>
                            <select id="country" name="country" class="form-control custom-text-color">
                                <option value="">Select a country</option>
                                {% for country in countries %}
                                    <option value="{{ country }}" {% if country == state.country %}selected{% endif %}>{{ country }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="id_state" class="custom-text-color">State</label>
                            <select id="state" name="state" class="form-control custom-text-color">
                                <option value="">Select a state</option>
                                {% if state %}
                                    <option value="{{ state.name }}" selected>{{ state.name }}</option>
                                {% endif %}
                            </select>
                        </div>
                    </div>
                </div>
                <button type="submit" class="btn btn-primary">Update</button>
            </form>
            {% else %}
            <h4>User not found or not logged in.</h4>
            {% endif %}
        </div>
        <div class="modal fade" id="successModal" tabindex="-1" role="dialog" aria-labelledby="successModalLabel" aria-hidden="true">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="successModalLabel">Success</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body" id="successModalBody">
                        <!-- Success message will be inserted here -->
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Bootstrap JS and dependencies -->
        <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
        <script src="https://cdn.jsdelivr.net/jquery.validation/1.19.3/jquery.validate.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.4/dist/umd/popper.min.js"></script>
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
        <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js"></script>
        <script>
        $(document).ready(function() {
            const $country = $('#country');
            const $state = $('#state');
            
            function loadStates(country) {
                $state.empty().append('<option value="">Select a state</option>').prop('disabled', true);
                
                if (!country) {
                    return;
                }
                
                $.ajax({
                    url: '{% url "ajax_load_states" %}',  // Make sure this URL name is correct
                    data: { 'country': country },
                    dataType: 'json'
                })
                .done(function(data) {
                    if (data.error) {
                        console.error('Error:', data.error);
                        return;
                    }
                    
                    data.forEach(function(state) {
                        $state.append($('<option>', {
                            value: state.name,
                            text: state.name
                        }));
                    });
                })
                .fail(function(jqXHR, textStatus, errorThrown) {
                    console.error('AJAX error:', textStatus, errorThrown);
                })
                .always(function() {
                    $state.prop('disabled', false);
                });
            }
            $country.change(function() {
                loadStates($(this).val());
            });
        
            // Load states for the initial country selection
            if ($country.val()) {
                loadStates($country.val());
            }
            $("#profileForm").validate({
        rules: {
            first_name: {
                required: true,
                minlength: 2
            },
            last_name: {
                required: true,
                minlength: 2
            },
            email: {
                required: true,
                email: true
            },
            phone_number: {
                required: true,
                digits: true,
                minlength: 10,
                maxlength: 15
            },
            street: {
                required: true,
                minlength: 5
            },
            city: {
                required: true,
                minlength: 2
            },
            zip_code: {
                required: true,
                digits: true,
                minlength: 5,
                maxlength: 10
            },
            country: {
                required: true
            },
            state: {
                required: true
            }
        },
        messages: {
            first_name: {
                required: "Please enter your first name",
                minlength: "Your first name must be at least 2 characters long"
            },
            last_name: {
                required: "Please enter your last name",
                minlength: "Your last name must be at least 2 characters long"
            },
            email: {
                required: "Please enter your email address",
                email: "Please enter a valid email address"
            },
            phone_number: {
                required: "Please enter your phone number",
                digits: "Please enter only digits",
                minlength: "Your phone number must be at least 10 digits long",
                maxlength: "Your phone number must not be more than 15 digits long"
            },
            street: {
                required: "Please enter your street address",
                minlength: "Your street address must be at least 5 characters long"
            },
            city: {
                required: "Please enter your city",
                minlength: "Your city must be at least 2 characters long"
            },
            zip_code: {
                required: "Please enter your zip code",
                digits: "Please enter only digits",
                minlength: "Your zip code must be at least 5 digits long",
                maxlength: "Your zip code must not be more than 10 digits long"
            },
            country: {
                required: "Please select your country"
            },
            state: {
                required: "Please select your state"
            }
        },
        errorElement: 'span',
        errorPlacement: function (error, element) {
            error.addClass('invalid-feedback');
            element.closest('.form-group').append(error);
        },
        highlight: function (element, errorClass, validClass) {
            $(element).addClass('is-invalid');
        },
        unhighlight: function (element, errorClass, validClass) {
            $(element).removeClass('is-invalid');
        }
            });
        });
</script>

<script>
    $(document).ready(function() {
        {% for message in messages %}
            {% if message.tags == 'success' %}
                var successModal = $('#successModal');
                $('#successModalBody').text("{{ message|escapejs }}");
                successModal.modal('show');
            {% endif %}
        {% endfor %}
    });
</script>
</body>
<html>
    